name: Terraform Apply

on:
  workflow_run:
    workflows: ["Terraform Plan"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  TF_DIR: infra/terraform
  TERRAFORM_VERSION: '1.5.7'

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_dispatch')

    steps:
    - name: Checkout código
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.workflow_run.head_branch || github.ref }}
        sha: ${{ github.event.workflow_run.head_sha || github.sha }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Login na Azure via Service Principal
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Terraform Init
      working-directory: ${{ env.TF_DIR }}
      run: terraform init

    - name: Obter Subscription ID
      id: get-subscription
      run: |
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        echo "subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_OUTPUT
        echo "Subscription ID: $SUBSCRIPTION_ID"

    - name: Import Resource Group existente (se necessário)
      working-directory: ${{ env.TF_DIR }}
      run: |
        RG_NAME="rg-burguer404-Catalogo"
        SUBSCRIPTION_ID="${{ steps.get-subscription.outputs.subscription_id }}"
        
        # Verifica se o resource group existe no Azure
        if az group show --name "$RG_NAME" &>/dev/null; then
          echo "Resource Group $RG_NAME existe no Azure"
          echo "Tentando importar para o state do Terraform..."
          # Tenta importar - se já estiver no state, vai falhar mas não é crítico
          terraform import azurerm_resource_group.rg[0] /subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME || \
          echo "Resource Group já está no state ou não pode ser importado (será criado se necessário)"
        else
          echo "Resource Group $RG_NAME não existe no Azure, será criado pelo Terraform"
        fi
      continue-on-error: true

    - name: Import AKS Cluster existente (se necessário)
      working-directory: ${{ env.TF_DIR }}
      run: |
        CLUSTER_NAME="aks-burguer404-Catalogo"
        RG_NAME="rg-burguer404-Catalogo"
        SUBSCRIPTION_ID="${{ steps.get-subscription.outputs.subscription_id }}"
        
        # Verifica se o cluster AKS existe no Azure
        if az aks show --name "$CLUSTER_NAME" --resource-group "$RG_NAME" &>/dev/null; then
          echo "Cluster AKS $CLUSTER_NAME existe no Azure"
          echo "Tentando importar para o state do Terraform..."
          # Importa o cluster AKS
          terraform import azurerm_kubernetes_cluster.aks /subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$CLUSTER_NAME || \
          echo "Cluster AKS já está no state ou não pode ser importado"
        else
          echo "Cluster AKS $CLUSTER_NAME não existe no Azure, será criado pelo Terraform"
        fi
      continue-on-error: true

    - name: Terraform Plan
      working-directory: ${{ env.TF_DIR }}
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      working-directory: ${{ env.TF_DIR }}
      run: terraform apply -auto-approve tfplan

    - name: Output Terraform
      working-directory: ${{ env.TF_DIR }}
      run: terraform output

